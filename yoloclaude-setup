#!/bin/bash
#
# yoloclaude-setup - One-time setup for yoloclaude sandboxed Claude Code environment
#
# This script creates a 'claude' user account with appropriate permissions
# for running Claude Code in a sandboxed environment.
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "This script must be run as root (use sudo)"
    fi
}

# Detect platform
detect_platform() {
    case "$(uname -s)" in
        Darwin*)
            PLATFORM="macos"
            ;;
        Linux*)
            PLATFORM="linux"
            ;;
        *)
            error "Unsupported platform: $(uname -s)"
            ;;
    esac
    info "Detected platform: $PLATFORM"
}

# Check if claude user already exists
user_exists() {
    if [[ "$PLATFORM" == "macos" ]]; then
        dscl . -read /Users/claude &>/dev/null
    else
        id claude &>/dev/null
    fi
}

# Get the invoking user (the one who ran sudo)
get_invoking_user() {
    INVOKING_USER="${SUDO_USER:-$USER}"
    if [[ "$INVOKING_USER" == "root" ]]; then
        error "Cannot determine invoking user. Please run with 'sudo' from a regular user account."
    fi
    info "Invoking user: $INVOKING_USER"
}

# Create claude user on macOS
create_user_macos() {
    info "Creating claude user on macOS..."

    # Find an available UID (start at 550 to avoid conflicts)
    local uid=550
    while dscl . -list /Users UniqueID | grep -q "\\b$uid\\b"; do
        ((uid++))
    done

    # Create the user
    dscl . -create /Users/claude
    dscl . -create /Users/claude UserShell /bin/bash
    dscl . -create /Users/claude RealName "Claude Code Sandbox"
    dscl . -create /Users/claude UniqueID "$uid"
    dscl . -create /Users/claude PrimaryGroupID 20  # staff group
    dscl . -create /Users/claude NFSHomeDirectory /Users/claude

    # Create home directory
    createhomedir -c -u claude 2>/dev/null || mkdir -p /Users/claude
    chown -R claude:staff /Users/claude

    # Hide user from login screen
    dscl . -create /Users/claude IsHidden 1

    info "Created claude user with UID $uid"

    # Create a keychain for the claude user
    # This is needed for Claude Code to store OAuth credentials
    setup_macos_keychain
}

# Set up keychain for claude user on macOS
setup_macos_keychain() {
    info "Setting up keychain for claude user..."

    local keychain_dir="/Users/claude/Library/Keychains"
    local keychain_path="$keychain_dir/login.keychain-db"

    # Create Keychains directory if it doesn't exist
    sudo -H -u claude mkdir -p "$keychain_dir"

    # Create the keychain with a simple password (security is via Unix permissions, not keychain password)
    # The keychain password is 'claude' - this is fine since the user account itself is the security boundary
    sudo -H -u claude security create-keychain -p "claude" "$keychain_path" 2>/dev/null || true

    # Set it as the default keychain
    sudo -H -u claude security default-keychain -s "$keychain_path" 2>/dev/null || true

    # Unlock the keychain (it will stay unlocked for this session)
    sudo -H -u claude security unlock-keychain -p "claude" "$keychain_path" 2>/dev/null || true

    # Set keychain settings to not auto-lock (since this is a service account)
    sudo -H -u claude security set-keychain-settings "$keychain_path" 2>/dev/null || true

    info "Keychain created at $keychain_path"
}

# Create claude user on Linux
create_user_linux() {
    info "Creating claude user on Linux..."

    # Create system user with home directory
    useradd --system --create-home --shell /bin/bash --comment "Claude Code Sandbox" claude

    info "Created claude user"
}

# Create directory structure
create_directories() {
    info "Creating directory structure..."

    local claude_home
    if [[ "$PLATFORM" == "macos" ]]; then
        claude_home="/Users/claude"
    else
        claude_home="/home/claude"
    fi

    mkdir -p "$claude_home/projects"
    mkdir -p "$claude_home/.yoloclaude"

    # Only chown the directories we created, not the entire home
    # (macOS creates system-protected dirs in ~/Library that even root can't modify)
    chown -R claude:$(id -gn claude) "$claude_home/projects"
    chown -R claude:$(id -gn claude) "$claude_home/.yoloclaude"

    info "Created $claude_home/projects and $claude_home/.yoloclaude"
}

# Set up shared temp directory for Claude Code scratchpad
setup_shared_temp() {
    info "Setting up shared temp directory for Claude Code..."

    local tmp_dir
    if [[ "$PLATFORM" == "macos" ]]; then
        tmp_dir="/private/tmp/claude"
    else
        tmp_dir="/tmp/claude"
    fi

    # Create directory with sticky bit (like /tmp itself)
    # This allows multiple users to run Claude Code without conflicts
    mkdir -p "$tmp_dir"
    chmod 1777 "$tmp_dir"

    info "Created $tmp_dir with sticky bit (mode 1777)"
}

# Configure sudo rules
configure_sudo() {
    info "Configuring sudo rules..."

    local sudoers_file="/etc/sudoers.d/yoloclaude"

    # Create sudoers rule allowing invoking user to run commands as claude without password
    cat > "$sudoers_file" << EOF
# Allow $INVOKING_USER to run commands as claude without password
$INVOKING_USER ALL=(claude) NOPASSWD: ALL
EOF

    chmod 440 "$sudoers_file"

    # Validate sudoers file
    if ! visudo -c -f "$sudoers_file" &>/dev/null; then
        rm -f "$sudoers_file"
        error "Failed to create valid sudoers file"
    fi

    info "Created $sudoers_file"
}

# Set up git config for claude user
setup_git_config() {
    info "Setting up git configuration for claude user..."

    local claude_home
    if [[ "$PLATFORM" == "macos" ]]; then
        claude_home="/Users/claude"
    else
        claude_home="/home/claude"
    fi

    # Create .gitconfig
    # Note: -H flag ensures HOME is set to claude's home directory (critical on macOS)
    sudo -H -u claude git config --global user.name "Claude Code"
    sudo -H -u claude git config --global user.email "claude@localhost"
    sudo -H -u claude git config --global init.defaultBranch main

    # Allow claude to access repos owned by other users
    # This is needed because claude clones from the invoking user's local repos
    sudo -H -u claude git config --global safe.directory '*'

    info "Configured git for claude user"
}

# Set up PATH for the claude user
setup_claude_path() {
    local claude_home
    if [[ "$PLATFORM" == "macos" ]]; then
        claude_home="/Users/claude"
    else
        claude_home="/home/claude"
    fi

    # Add ~/.local/bin to PATH in both .bashrc and .zshrc
    local path_line='export PATH="$HOME/.local/bin:$PATH"'

    for rcfile in ".bashrc" ".zshrc" ".profile"; do
        local rcpath="$claude_home/$rcfile"
        # Create file if it doesn't exist, or append if the line isn't already there
        if [[ ! -f "$rcpath" ]] || ! grep -qF '.local/bin' "$rcpath" 2>/dev/null; then
            echo "$path_line" | sudo -H -u claude tee -a "$rcpath" > /dev/null
        fi
    done

    info "Added ~/.local/bin to claude user's PATH"
}

# Install Claude Code for the claude user
install_claude_code() {
    info "Installing Claude Code for claude user..."

    # First ensure PATH is set up so the installer's advice is already handled
    setup_claude_path

    # Use the official installer, which installs to ~/.local/bin/claude
    # The -H flag ensures HOME is set correctly
    if sudo -H -u claude bash -c 'curl -fsSL https://claude.ai/install.sh | sh'; then
        info "Claude Code installed successfully"
        return 0
    else
        warn "Claude Code installation failed"
        warn "You can install manually later: sudo -H -u claude -i"
        warn "Then run: curl -fsSL https://claude.ai/install.sh | sh"
        return 1
    fi
}

# Set up user-level CLAUDE.md with yoloclaude environment instructions
setup_claude_md() {
    info "Setting up user-level CLAUDE.md for claude user..."

    local claude_home
    if [[ "$PLATFORM" == "macos" ]]; then
        claude_home="/Users/claude"
    else
        claude_home="/home/claude"
    fi

    local claude_md_dir="$claude_home/.claude"
    local claude_md_path="$claude_md_dir/CLAUDE.md"

    # Create .claude directory if needed
    sudo -H -u claude mkdir -p "$claude_md_dir"

    # Write the CLAUDE.md file
    cat << 'CLAUDE_MD_EOF' | sudo -H -u claude tee "$claude_md_path" > /dev/null
# yoloclaude Sandbox Environment

You are running inside a **yoloclaude sandbox**. This provides isolation
between you and the invoking user's environment.

## Key Points

**Git origin is local, not remote:**
- Your git `origin` points to the invoking user's local repo, not GitHub/GitLab
- This is intentional for sandbox isolation

**Do NOT try to push:**
- You cannot push directly (permission denied is expected)
- **yoloclaude handles syncing** when the session ends
- Just commit your changes normally - sync happens automatically

**You are the `claude` user:**
- Isolated Unix user with its own home directory
- You're working in a git worktree under ~/projects/<project>/worktrees/
- Each session gets its own worktree branch

## Workflow

1. Make changes and commit them normally
2. When the session ends, yoloclaude will:
   - Sync your commits to the invoking user's repo
   - Offer to merge into their branch
   - Offer to push to the remote

If you see "permission denied" on push, this is expected - just let the
session end and yoloclaude will handle it.
CLAUDE_MD_EOF

    info "Created $claude_md_path"
}

# Print final instructions
print_instructions() {
    local claude_home
    local claude_installed=false
    if [[ "$PLATFORM" == "macos" ]]; then
        claude_home="/Users/claude"
    else
        claude_home="/home/claude"
    fi

    # Check if claude is available to the claude user
    if sudo -H -u claude bash -c 'command -v claude' &>/dev/null; then
        claude_installed=true
    fi

    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Setup complete!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo "Next steps:"
    echo ""

    if [[ "$claude_installed" == "true" ]]; then
        echo "1. Authenticate Claude Code for the claude user:"
        echo "   sudo -H -u claude -i claude"
        echo ""
        echo "   This will open Claude Code and prompt you to log in."
        echo "   Complete the authentication, then exit with /exit or Ctrl+C."
        echo ""
        echo "2. Start using yoloclaude:"
    else
        echo "1. Install Claude Code for the claude user:"
        echo "   sudo -H -u claude -i"
        echo "   curl -fsSL https://claude.ai/install.sh | sh"
        echo "   exit"
        echo ""
        echo "2. Authenticate Claude Code for the claude user:"
        echo "   sudo -H -u claude -i claude"
        echo ""
        echo "   This will open Claude Code and prompt you to log in."
        echo "   Complete the authentication, then exit with /exit or Ctrl+C."
        echo ""
        echo "3. Start using yoloclaude:"
    fi
    echo "   yoloclaude https://github.com/user/repo"
    echo "   yoloclaude /path/to/local/repo"
    echo ""
    echo "The claude user's home directory is: $claude_home"
    echo "Projects will be cloned to: $claude_home/projects/"
    echo ""
}

# Main
main() {
    echo "yoloclaude-setup - Setting up Claude Code sandbox environment"
    echo ""

    check_root
    detect_platform
    get_invoking_user

    if user_exists; then
        warn "User 'claude' already exists. Skipping user creation."
    else
        if [[ "$PLATFORM" == "macos" ]]; then
            create_user_macos
        else
            create_user_linux
        fi
    fi

    create_directories
    setup_shared_temp
    configure_sudo
    setup_git_config
    setup_claude_md
    install_claude_code || true  # Don't fail if install fails - user can install manually
    print_instructions
}

main "$@"
